# Flux-KV (åŸºäº Go çš„é«˜å¹¶å‘åˆ†å¸ƒå¼é”®å€¼å­˜å‚¨ç³»ç»Ÿ)

è¿™æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„åˆ†å¸ƒå¼ KV å­˜å‚¨ç³»ç»Ÿä¸å¾®æœåŠ¡ç½‘å…³é¡¹ç›®ï¼Œé›†æˆäº† Go è¯­è¨€æ ¸å¿ƒç‰¹æ€§ä¸äº‘åŸç”ŸæŠ€æœ¯æ ˆã€‚

æœ¬é¡¹ç›®æ—¨åœ¨æ„å»ºä¸€ä¸ªé«˜å¹¶å‘ã€å¼ºä¸€è‡´æ€§ã€å·¥ä¸šçº§çš„åˆ†å¸ƒå¼ KV å­˜å‚¨ä¸ç½‘å…³ç³»ç»Ÿã€‚

## ğŸš€ åŠŸèƒ½ç‰¹æ€§

### åˆ†å¸ƒå¼ KV å­˜å‚¨
- **é«˜æ€§èƒ½å­˜å‚¨**: 
  - [x] åŸºäº sync.RWMutex çš„åŸºç¡€å­˜å‚¨
  - [x] **åˆ†ç‰‡é” (Sharded Map) ä¼˜åŒ–**: é™ä½é«˜å¹¶å‘å†™å†²çª
- **äº‹ä»¶é©±åŠ¨æ¶æ„**:
  - [x] **CDC (Change Data Capture)**: å®æ—¶æ•°æ®å˜æ›´æµ
  - [x] **RabbitMQ é›†æˆ**: å¼‚æ­¥è§£è€¦ä¸å‰Šå³°å¡«è°·
- **æŒä¹…åŒ–**: æ”¯æŒ AOF (Append Only File) æŒä¹…åŒ–ä¸å¯åŠ¨æ¢å¤ã€‚
- **è¿‡æœŸæœºåˆ¶**: å®ç° Lazy + Active æ··åˆè¿‡æœŸæ¸…ç†ç­–ç•¥ã€‚
- **é€šä¿¡åè®®**: è‡ªå®šä¹‰ TCP åè®®ï¼ˆè§£å†³ç²˜åŒ…é—®é¢˜ï¼‰ä¸ gRPC æ¥å£æ”¯æŒã€‚
- **ä¸€è‡´æ€§**: ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•å®ç°æ•°æ®åˆ†ç‰‡ã€‚

### å¾®æœåŠ¡ç½‘å…³
- **æœåŠ¡å‘ç°**: é›†æˆ Etcd å®ç°åŠ¨æ€æœåŠ¡æ³¨å†Œä¸å‘ç°ã€‚
- **åŠ¨æ€ä»£ç†**: HTTP è½¬ gRPC æ³›åŒ–è°ƒç”¨ã€‚
- **é«˜å¯ç”¨**: 
  - å…¨å±€é™æµ (Token Bucket)
  - ç†”æ–­é™çº§ (Hystrix)
  - è´Ÿè½½å‡è¡¡ (RoundRobin)
  - é˜²ç¼“å­˜å‡»ç©¿ (SingleFlight)
- **å·¥ç¨‹åŒ–**:
  - [x] ä¼˜é›…å¯åœ (Graceful Shutdown)
  - [x] Docker Compose å…¨æ ˆå®¹å™¨åŒ–ç¼–æ’
- **å¯è§‚æµ‹æ€§**: é›†æˆ OpenTelemetry/Jaeger é“¾è·¯è¿½è¸ªä¸ Prometheus æŒ‡æ ‡ç›‘æ§ã€‚

## ğŸ› ï¸ å¿«é€Ÿå¼€å§‹

### å‰ç½®æ¡ä»¶
- Go 1.22+
- Etcd (ç”¨äºæœåŠ¡å‘ç°)
- Jaeger (å¯é€‰ï¼Œç”¨äºé“¾è·¯è¿½è¸ª)

### è¿è¡ŒæœåŠ¡ç«¯ (KV Server)
```bash
go run cmd/server/main.go
```

### è¿è¡Œç½‘å…³ (Gateway)
```bash
go run cmd/gateway/main.go
```

### è¿è¡Œå®¢æˆ·ç«¯æµ‹è¯•
```bash
go run cmd/client/main.go
```

## ğŸ³ Docker å¿«é€Ÿéƒ¨ç½² (æ¨è)

æœ¬é¡¹ç›®æ”¯æŒ Docker Compose ä¸€é”®æ‹‰èµ·å®Œæ•´ç¯å¢ƒ (Etcd + RabbitMQ + Jaeger + KV Nodes + Gateway)ã€‚
è¯¦ç»†çš„æ“ä½œæŒ‡å—ã€é›†ç¾¤æ‰©å®¹å’Œè¿ç»´å‘½ä»¤è¯·å‚è€ƒ [Docker éƒ¨ç½²æ‰‹å†Œ](docs/DOCKER.md)ã€‚

### 1. æ„å»ºå¹¶å¯åŠ¨é›†ç¾¤
```bash
docker-compose up --build -d
```

### 2. æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€
```bash
docker-compose ps
```

### 3. æ“ä½œéªŒè¯
```bash
# å†™å…¥æ•°æ® (HTTP -> Gateway -> KV Node)
curl -X POST -d "key=hello&value=world" http://localhost:8080/api/v1/kv

# éªŒè¯ CDC å¼‚æ­¥æ—¥å¿—
docker logs -f flux-cdc-consumer
```

### 4. è®¿é—®ç®¡ç†åå°
- **Jaeger UI**: http://localhost:16686
- **RabbitMQ**: http://localhost:15672 (User: fluxadmin / Pass: flux2026secure)

## ğŸ“Š æ€§èƒ½è¡¨ç°

æˆ‘ä»¬é’ˆå¯¹ç³»ç»Ÿçš„æ ¸å¿ƒç»„ä»¶è¿›è¡Œäº†ä¸¥æ ¼çš„åŸºå‡†æµ‹è¯• (Benchmark)ï¼Œæ¶µç›–äº†å†™å¯†é›†å‹åœºæ™¯ã€CDC å¼‚æ­¥å¤„ç†å½±å“ä»¥åŠé”ç«äº‰åˆ†æã€‚

è¯¦ç»†çš„å‹æµ‹æ•°æ®å’Œåˆ†ææŠ¥å‘Šè¯·å‚é˜… [æ€§èƒ½æµ‹è¯•æŠ¥å‘Š](PERFORMANCE.md)ã€‚

## ğŸ“ ç›®å½•ç»“æ„
```
â”œâ”€â”€ api/            # IDL å®šä¹‰ (Proto/gRPC)
â”œâ”€â”€ cmd/            # ç¨‹åºå…¥å£ (Gateway, Server, Client)
â”œâ”€â”€ configs/        # é…ç½®æ–‡ä»¶
â”œâ”€â”€ internal/       # ç§æœ‰ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ core/       #å­˜å‚¨å¼•æ“æ ¸å¿ƒ (MemDB)
â”‚   â”œâ”€â”€ gateway/    # ç½‘å…³æ ¸å¿ƒé€»è¾‘
â”‚   â”œâ”€â”€ protocol/   # é€šä¿¡åè®®
â”‚   â””â”€â”€ service/    # gRPC æœåŠ¡å®ç°
â”œâ”€â”€ pkg/            # å…¬å…±åº“ (Client, Logger, Discovery)
â”œâ”€â”€ scripts/        # æµ‹è¯•ä¸è¿ç»´è„šæœ¬
â””â”€â”€ tools/          # å·¥å…·é›†
```
